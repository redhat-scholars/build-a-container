<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Containers and OpenShift :: Build a Container Workshop (Dev Mode)</title>
    <link rel="canonical" href="http://localhost:3000/rhs-build-course/index.html/intro-container-workshop/BASE/deploy-container.html">
    <link rel="prev" href="build-your-own-container.html">
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../../_/css/site.css">
<link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <style>
    /* override master stylesheet properties for this partial here */

    .navbar-item {
      flex: unset;
    }

    .doc {
      max-width: unset;
    }


  </style>

  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img
          src="../../_/img/header_logo.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="http://localhost:3000/rhs-build-course/index.html">Build a Container Workshop (Dev Mode)</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
        <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-scholars.github.io/outer-loop-guides/" target="_blank">Outer Loop</a>
            <a class="navbar-item" href="https://redhat-scholars.github.io/openshift-starter-guides/" target="_blank">OpenShift Starter</a>
            <a class="navbar-item" href="https://redhat-scholars.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-scholars.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-scholars.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header><div class="body">
<div class="nav-container" data-component="intro-container-workshop" data-version="BASE">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html" class=" query-params-link">Build a Container Workshop</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="introduction.html">Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="introduction.html#open_code_server">Code Server</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="introduction.html#open_code_server_terminal">Open terminal</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="introduction.html#open_code_server_terminal_commands">Issuing Terminal Commands</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="introduction.html#local_browser">Local Browser</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="container-autopsy.html">Container Autopsy</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="container-autopsy.html#what_makes_up_a_container">What makes up a Container?</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="container-autopsy.html#container_image_format">Container Image Format</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="container-autopsy.html#container_file">Containerfile</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="container-autopsy.html#container_identification">Container Identification</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="container-autopsy.html#container_runtime">Container Runtime</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="container-autopsy.html#container_tools">Container Tools</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="container-autopsy.html#container_registries">Container Registries</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="container-autopsy.html#more_information">More information</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="podman-intro.html">Running Containers</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="podman-intro.html#run_container">Add a website</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="podman-intro.html#enter_container">Look inside a container</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="podman-intro.html#copy_data">Copying data out</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="podman-intro.html#committing_containers">Committing Containers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="podman-intro.html#stop_container">Stopping Containers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="podman-intro.html#remove_containers">Removing Containers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="podman-intro.html#rerunning_container">Re-running Containers</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="container-persistence.html">Persistence and Containers</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="container-persistence.html#mounting_volumes">Mounting Volumes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="container-persistence.html#test_mount">Testing the Volume Mount</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="containers-and-security.html">Container Security Considerations</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="containers-and-security.html#exploit_containers">Exploit a Container</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="containers-and-security.html#run_containers_responsibly">Run Containers Responsibly</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="containers-and-security.html#scanning_containers">Scanning Containers for Security Issues</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="build-your-own-container.html">Building Securely</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="build-your-own-container.html#buildah_native">Buildah Native Commands</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="build-your-own-container.html#buildah_containerfile">Buildah and Containerfiles</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="deploy-container.html">Deploying Containers</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#openshift_login">OpenShift Login</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#image_registry">Upload to Image Registry</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#simple_container_run">Run Container Image on OpenShift</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#expose_container">Exposing Container Website</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#openshift_security">OpenShift Security</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Build a Container Workshop</span>
    <span class="version">BASE</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Build a Container Workshop</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">BASE</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Build a Container Workshop</a></li>
    <li><a href="deploy-container.html">Deploying Containers</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="file:///workspaces/container-workshop/documentation/modules/ROOT/pages/deploy-container.adoc">Edit this Page</a></div>
</div>
  <div class="content">
<article class="doc">
<h1 class="page">Containers and OpenShift</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Now that we have a container let&#8217;s demonstrate how one might deploy that container to a platform like Red Hat&#8217;s Enterprise Kubernetes solution, OpenShift.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="openshift_login"><a class="anchor" href="#openshift_login"></a>Login to OpenShift</h2>
<div class="sectionbody">
<div class="paragraph">
<p>First, let&#8217;s log into your OpenShift cluster.  Choose the tab that is most appropriate to your current lab.  If you are unsure, ask your lab techs.</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset1_provisioned"></a>Provisioned</p>
</li>
<li>
<p><a id="tabset1_openshift-developer-sandox"></a>OpenShift Developer Sandox</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset1_provisioned">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>You should be able to reach the OpenShift cluster provisioned for this lab <a href="https://console-openshift-console.apps.%CLUSTER_SUBDOMAIN%/" target="_blank" rel="noopener">here</a></p>
</li>
<li>
<p>You should be met with a login challenge screen</p>
<div class="imageblock">
<div class="content">
<img src="_images/openshift-login-challenge.png" alt="openshift login challenge">
</div>
</div>
</li>
<li>
<p>Enter the following details</p>
<div class="ulist">
<ul>
<li>
<p><strong>Username</strong>: %USER%</p>
</li>
<li>
<p><strong>Password</strong>: openshift</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset1_openshift-developer-sandox">
<div class="sidebarblock">
<div class="content">
<div class="title">PREREQUISITES</div>
<div class="paragraph">
<p>This section assumes you:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Already have a Red Hat account</p>
</li>
<li>
<p>Requested and have had an OpenShift Developer Sandbox approved prior to attempting this section</p>
</li>
</ul>
</div>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Navigate to the <a href="https://red.ht/dev-sandbox" target="_blank" rel="noopener">Red Hat Developer OpenShift Developer Sandbox page</a></p>
</li>
<li>
<p>Click on "start your sandbox" and enter your Red Hat account login details</p>
</li>
<li>
<p>From the OpenShift sandbox page, log into your sandbox by clicking on the "DevSandbox" button on the login challenge page</p>
<div class="imageblock">
<div class="content">
<img src="_images/dev-sandbox-login-challenge.png" alt="dev sandbox login challenge">
</div>
</div>
</li>
<li>
<p>Once you login, you should see your <code>-dev</code> project in the Developer Perspective</p>
<div class="imageblock">
<div class="content">
<img src="_images/dev-sandbox-dev-perspective.png" alt="dev sandbox dev perspective">
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>If you&#8217;ve logged in successfully, you should find yourself on the (empty) start page for the Developer Perspective one the <code>%USER%</code> project<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup></p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ocp-developer-perspective.png" alt="ocp developer perspective">
</div>
</div>
<div class="sect2">
<h3 id="_console_login"><a class="anchor" href="#_console_login"></a>Console Login</h3>
<div class="paragraph">
<p>For this section we&#8217;re going to want to issue commands to OpenShift from the commandline.  OpenShift has a CLI called <code>oc</code> <sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup> which we will leverage.</p>
</div>
<div class="paragraph">
<p>Here again, choose the proper tab for your setup</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset2_provisioned"></a>Provisioned</p>
</li>
<li>
<p><a id="tabset2_openshift-developer-sandbox"></a>OpenShift Developer Sandbox</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset2_provisioned">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>From the (CodeServer) terminal, enter the following command to log into OpenShift</p>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc login <a href="https://api.%CLUSTER_SUBDOMAIN%:6443" class="bare">https://api.%CLUSTER_SUBDOMAIN%:6443</a> \<i class="conum" data-value="1"></i><b>(1)</b>
    --username %USER% \
    --password 'openshift'</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This is the URL of the REST API for OpenShift with which the CLI interacts</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Insecure connections</div>
<div class="paragraph">
<p>If you are met the with following question in the console</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">The server uses a certificate signed by an unknown authority.
You can bypass the certificate check, but any data you send to the server could be intercepted by others.
Use insecure connections? (y/n):</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can safely answer <code>y</code> (yes) at the prompt</p>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset2_openshift-developer-sandbox">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>From your OpenShift Console UI, click the dropdown in the upper right (with your account name) and select <code>Copy login command</code></p>
<div class="imageblock">
<div class="content">
<img src="_images/copy-login-command.png" alt="copy login command">
</div>
</div>
</li>
<li>
<p>Next, when presented the login challenge select <code>DevSandbox</code></p>
<div class="imageblock">
<div class="content">
<img src="_images/dev-sandbox-login-challenge.png" alt="dev sandbox login challenge">
</div>
</div>
</li>
<li>
<p>Click the "Display Token" link</p>
</li>
<li>
<p>Copy the string as indicated in the image</p>
<div class="imageblock">
<div class="content">
<img src="_images/copy-login-token.png" alt="copy login token">
</div>
</div>
</li>
<li>
<p>Paste the command into a Code Server terminal</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>If you have logged on successfully, running the following command:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc whoami</code></pre>
</div>
</div>
<div class="paragraph">
<p>Should yield your OpenShift username (below represents username shown if using Provisioned Cluster)</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">%USER%</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="image_registry"><a class="anchor" href="#image_registry"></a>Upload Image to Image Registry</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let&#8217;s go back to the container that we finished <a href="build-your-own-container.html#finished_container" class="page" target="_blank" rel="noopener">here</a> and look at what a simple deployment to the <code>%USER%</code> project.</p>
</div>
<div class="sect2">
<h3 id="_openshift_and_image_registries"><a class="anchor" href="#_openshift_and_image_registries"></a>OpenShift and Image Registries</h3>
<div class="paragraph">
<p>In order to be able to run an image in OpenShift or Kubernetes we need to put our image somewhere we&#8217;re OpenShift can find it.  This usually involves uplaoding the image to either a public or private container registry.  Public registries include Red Hat&#8217;s <a href="quay.io" target="_blank" rel="noopener">quay.io</a> and Docker&#8217;s <a href="https://hub.docker.com/" target="_blank" rel="noopener">Docker Hub</a></p>
</div>
<div class="paragraph">
<p>One of the features that OpenShift adds to Kubernetes is an in-built container registry called an <code>ImageStream</code>.  We&#8217;re going to create an <code>ImageStream</code> to upload our container to where OpenShift can find it.</p>
</div>
<div class="paragraph">
<p>We can create the image stream either from the OpenShift Console (UI) or from the terminal (command line).</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Enter the following command</p>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc create imagestream \<i class="conum" data-value="1"></i><b>(1)</b>
    -n %USER% \<i class="conum" data-value="2"></i><b>(2)</b>
    my-secure-web-server-image <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>ImageStream</code> is an OpenShift specific Kubernetes resource that represents a project specific container registry</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This is the namespace the <code>ImageStream</code> should be bound to</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>This is the name of the image registry we want to create</td>
</tr>
</table>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">imagestream.image.openshift.io/my-secure-web-server-image created</code></pre>
</div>
</div>
</li>
<li>
<p>With our <code>ImageStream</code> created, we can find our registry endpoint with this command</p>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">OCP_REGISTRY_URL=$(oc get imagestream my-secure-web-server-image \
    -n %USER% \
    -o jsonpath='{.status.publicDockerImageRepository}') <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>-o</code> is used to specify the output type.  In this case we specify <code>jsonpath</code> which means give the output as JSON and then act as if it were piped to <code>jq -r</code> meaning we specify the field in the JSON we are looking for</td>
</tr>
</table>
</div>
</li>
<li>
<p>Once we have the <code>publicDockerImageRepository</code> we can use podman to login into it with our OpenShift credentials</p>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">podman login \
    ${OCP_REGISTRY_URL} \
    --username %USER% \
    --password "$(oc whoami -t)" <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>You must log into imagestream registries using a token and not your user&#8217;s password.  <code>oc whoami -t</code> returns the currently active token for a given OpenShift session</td>
</tr>
</table>
</div>
</li>
<li>
<p>This should yield the following output, which indicates that you&#8217;ve authenticated with the <code>ImageStream</code> internal registry</p>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">Login Succeeded!</code></pre>
</div>
</div>
</li>
<li>
<p>Now we&#8217;re going to use a new <code>podman</code> command called <code>tag</code> to associate our local image with an image that could exist in our ImageStream registry</p>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">podman tag \
    localhost/secure-container \<i class="conum" data-value="1"></i><b>(1)</b>
    ${OCP_REGISTRY_URL}:latest <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This, remember is the local name of the image we created <a href="build-your-own-container.html#finished_container" class="page" target="_blank" rel="noopener">in the previous section</a></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>If you <code>echo</code> this in a shell, this will look something like <code>default-route-openshift-image-registry.apps.%CLUSTER_SUBDOMAIN%/%USER%/my-secure-web-server-image:latest</code> which is similar to container identification names as we discussed in the <a href="container-autopsy.html#container_identification" class="page" target="_blank" rel="noopener">Container Autopsy section</a></td>
</tr>
</table>
</div>
</li>
<li>
<p>Once tagged, we should now be able to push this image into the ImageStream using the <code>podman push</code> command</p>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">podman push ${OCP_REGISTRY_URL}:latest</code></pre>
</div>
</div>
</li>
<li>
<p>You should see output similar to the following</p>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">Getting image source signatures
Copying blob 1d505cb9245a done
Copying blob 9e12a51e507a done
Copying blob 01d2fb866535 done
Copying config f8b584bce6 done
Writing manifest to image destination
Storing signatures</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Now we have our image in a place where we can refer to it</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="simple_container_run"><a class="anchor" href="#simple_container_run"></a>Run Container Image on OpenShift</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The simplest way to get a container image up and running in OpenShift is with the <code>oc run</code> command.  This will create what&#8217;s called a <code>pod</code> to house our container that runs based on the image definition we just uploaded to the ImageStream</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>One of benefits of using ImageStreams is that the cluster internal addresss of the ImageStream repo does not require authentication.  Let&#8217;s use that for the image location for running our pod</p>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">CLUSTER_LOCAL_REGISTRY_URL=$(oc get imagestream \
    my-secure-web-server-image \<i class="conum" data-value="1"></i><b>(1)</b>
    -o jsonpath='{.status.dockerImageRepository}') <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Notice that this is the same ImageStream name we&#8217;ve been using</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This time we&#8217;re looking not for the <code>publicDockerImageRepository</code> from the ImageStream definition, but the <code>dockerImageRepository</code> which is the same as the cluster local address of the repo</td>
</tr>
</table>
</div>
</li>
<li>
<p>Run the following command from the Code Server terminal</p>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc run \
    my-web-server \<i class="conum" data-value="1"></i><b>(1)</b>
    -n %USER% \
    --image ${CLUSTER_LOCAL_REGISTRY_URL}:latest</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The name that will be given to the pod</td>
</tr>
</table>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">pod/my-web-server created</code></pre>
</div>
</div>
</li>
<li>
<p>Switch to the OpenShift Console (UI) and look at the <a href="https://console-openshift-console.apps.%CLUSTER_SUBDOMAIN%/topology/ns/%USER%?view=graph" target="_blank" rel="noopener">developer perpective for your project</a>.  You should see the pod running</p>
<div class="imageblock">
<div class="content">
<img src="_images/ocp-running-secure-image.png" alt="ocp running secure image">
</div>
<div class="title">Figure 1. Our image running in OpenShift</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="expose_container"><a class="anchor" href="#expose_container"></a>Exposing Container Website</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Our container is running in OpenShift, but we&#8217;d like the rest of the world to have access to our guestbook.  To do this on OpenShift we create a <code>Service</code> in that "exposes" our pod and then a <code>Route</code> that "exposes" our service to the world outside the OpenShift cluster.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc expose \<i class="conum" data-value="1"></i><b>(1)</b>
    --port 8080 \<i class="conum" data-value="2"></i><b>(2)</b>
    pod/my-web-server <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>expose</code> is an <code>oc</code> CLI specific command</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We want our service to expose port 8080</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Many resources can be exposed.  Exposing a pod (as we&#8217;re referencing here) creates a service that points to the pod based on the svcs the pod exports</td>
</tr>
</table>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">service/my-web-server exposed</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once our service is created, we can expose our <code>Service</code> (or <code>svc</code>)</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc expose \
    svc/my-web-server</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">route.route.openshift.io/my-web-server exposed</code></pre>
</div>
</div>
<div class="paragraph">
<p>Exposing our service creates a <code>Route</code> in OpenShift.  We can interrogate this created route to determine what the publicly accessible endpoint is for our service:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">echo "http://$(oc get route my-web-server -o jsonpath='{.spec.host}')/hello.html"</code></pre>
</div>
</div>
<div class="paragraph">
<p>This should return output something like this:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">http://my-web-server-%USER%.apps.%CLUSTER_SUBDOMAIN%/hello.html</code></pre>
</div>
</div>
<div class="paragraph">
<p>Copy the output and paste it into any internet connected browser.  You should get access to an operating guestbook</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/sandbox-website.png" alt="sandbox website">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="openshift_security"><a class="anchor" href="#openshift_security"></a>OpenShift Security</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This the <a href="build-your-own-container.html#basic_containerfile" class="page" target="_blank" rel="noopener">building secure container section</a> we spent a lot of time making our image suitable for running on OpenShift.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s take a quick look at how OpenShift adds a layer of protection around our running of images by looking at what happens when we try to run our insecure container on it.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>First let&#8217;s make use of OpenShift&#8217;s internal image registry again (the <code>ImageStream</code> we created before) by tagging the insecure image with a name that binds it to to that registry</p>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">podman tag \
    quay.io/mhildenb/container-workshop-httpd:0.0.6 \
    ${OCP_REGISTRY_URL}:insecure <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Same exact <code>ImageStream</code> image registry, just different tag</td>
</tr>
</table>
</div>
</li>
<li>
<p>With the image tagged for the <code>ImageStream</code> registry, we can now push it</p>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">podman push \
    ${OCP_REGISTRY_URL}:insecure</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">Getting image source signatures
Copying blob bcf3865bf7f7 done
Copying blob 86284899b0cc done
Copying blob c9e02f9d3afe done
Copying blob 4e7c990a129f done
Copying blob 210af8709b71 done
Copying blob 123257361dae done
Copying blob 47e96512450e done
Copying blob 8f10e6ebff19 done
Copying blob 486383b07939 done
Copying blob 23be1053bf93 done
Copying blob ee738432d587 done
Copying config 60dde8abf7 done
Writing manifest to image destination
Storing signatures</code></pre>
</div>
</div>
</li>
<li>
<p>Before we attempt to run our image, let&#8217;s setup a log watch so that we can see the logs of the pod.  We&#8217;ll do this in a separate terminal, so first split your terminal, this will be referred to as <strong>Terminal 2</strong></p>
<div class="imageblock">
<div class="content">
<img src="_images/terminal-split.png" alt="terminal split">
</div>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset3_terminal-2"></a>Terminal 2</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset3_terminal-2">
<div class="paragraph">
<p>To monitor our pod from the terminal we&#8217;re going to use a tool called <code>stern</code> (see here for more info).  It allows us to aggregate and view logs from our Kubernetes cluster.</p>
</div>
<div class="paragraph">
<p>To set up a log watch enter the following command</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">stern -n %USER% \<i class="conum" data-value="1"></i><b>(1)</b>
   my-web-server-insecure <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>-n</code> option tells the stern to watch for pods in the <code>%USER%</code> namespace</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This is a string that stern uses to match against any pods that exist in the specified namespace.  In this case this matches the name we are intending to give our pod</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</li>
<li>
<p>With our image pushed to the OpenShift image registry, we can now run the image in a pod using the following command (and the "Cluster Local" name of the registry which we obtained above)</p>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset4_terminal-1"></a>Terminal 1</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset4_terminal-1">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc run \
    my-web-server-insecure\<i class="conum" data-value="1"></i><b>(1)</b>
    -n %USER% \
    --image ${CLUSTER_LOCAL_REGISTRY_URL}:insecure <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Different pod name to distinguish from previous</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Same exact image registry, just different tag</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</li>
<li>
<p>As the pod starts up we should see the following output from the <code>stern</code> watch in the other terminal</p>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset5_terminal-2"></a>Terminal 2</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset5_terminal-2">
<div class="listingblock console-output">
<div class="title">Recurring <code>stern</code> output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">+ my-web-server-insecure › my-web-server-insecure <i class="conum" data-value="1"></i><b>(1)</b>
Error opening stream to student1/my-web-server-insecure: my-web-server-insecure
: container "my-web-server-insecure" in pod "my-web-server-insecure" is waiting to start: ContainerCreating
- my-web-server-insecure
+ my-web-server-insecure › my-web-server-insecure
Error opening stream to student1/my-web-server-insecure: my-web-server-insecure
: container "my-web-server-insecure" in pod "my-web-server-insecure" is waiting to start: ContainerCreating
- my-web-server-insecure
+ my-web-server-insecure › my-web-server-insecure
my-web-server-insecure my-web-server-insecure AH00558: httpd: Could not reliably determine the server's fully qualified domain name, using 10.128.2.16. Set the 'ServerName' directive globally to suppress this message
<mark>my-web-server-insecure my-web-server-insecure (13)Permission denied: AH00058: Error retrieving pid file logs/httpd.pid</mark>
<mark>my-web-server-insecure my-web-server-insecure AH00059: Remove it before continuing if it is corrupted.</mark>
- my-web-server-insecure</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>stern</code> outputs logs in the format pod-name &gt; container-name '</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. <em>project</em> is an OpenShift specific term.  For the purposes of this lab you can think of is as synonymous with the Kubernetes concept of a _namespace
</div>
<div class="footnote" id="_footnotedef_2">
<a href="#_footnoteref_2">2</a>. <code>oc</code> is built on top of <code>kubectl</code>, the generic Kubernetes CLI.  Any command you can issue with <code>kubectl</code> you can issue with <code>oc</code>, but <code>oc</code> builds upon <code>kubectl</code> with OpenShift specific commands, such as <code>oc login</code>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="build-your-own-container.html" class="query-params-link">Building Securely</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../../_/js/vendor/clipboard.js"></script>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>  </body>
</html>
