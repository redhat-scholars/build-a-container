<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Using Podman with Multiple Containers :: BUILD-A-CONTAINER WORKSHOP</title>
    <link rel="canonical" href="https://bfarr-rh.github.io/build-a-container/intro-container-workshop/1.0/PODMAN_COMPOSE/compose-container.html">
    <link rel="prev" href="../DATABASES/databases-and-containers.html">
    <link rel="next" href="../PODMAN_ROOTLESS/podman-rootless.html">
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../../../_/css/site.css">
<link rel="icon" href="../../../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script type="text/javascript">

   $( document ).ready(function() {
    $('li.version a, a.version').click(function() {
            var querystring = window.location.search;
            var href = $(this).attr('href');
            location.href = href + querystring;
            return false;
      });
  });
    
  </script>
  <style>
    /* override master stylesheet properties for this partial here */

    .navbar-item {
      flex: unset;
    }

    .doc {
      max-width: unset;
    }


  </style>

  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img
          src="../../../_/img/header_logo.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://bfarr-rh.github.io/build-a-container">BUILD-A-CONTAINER WORKSHOP</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
        <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-scholars.github.io/outer-loop-guides/" target="_blank">Outer Loop</a>
            <a class="navbar-item" href="https://redhat-scholars.github.io/openshift-starter-guides/" target="_blank">OpenShift Starter</a>
            <a class="navbar-item" href="https://redhat-scholars.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-scholars.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-scholars.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header><div class="body">
<div class="nav-container" data-component="intro-container-workshop" data-version="1.0">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html" class=" query-params-link">Build a Container Workshop</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../introduction.html">Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../introduction.html#open_code_server">Code Server</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../introduction.html#open_code_server_terminal">Open Terminal</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../introduction.html#open_code_server_terminal_commands">Issuing Terminal Commands</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../introduction.html#local_browser">Local Browser</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../container-anatomy.html">Container Anatomy</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../container-anatomy.html#what_makes_up_a_container">What makes up a Container?</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../container-anatomy.html#container_image_format">Container Image Format</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../container-anatomy.html#container_file">Containerfile</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../container-anatomy.html#container_identification">Container Identification</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../container-anatomy.html#container_runtime">Container Runtime</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../container-anatomy.html#container_tools">Container Tools</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../container-anatomy.html#container_registries">Container Registries</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../container-anatomy.html#more_information">More information</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../podman-intro.html">Running Containers</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../podman-intro.html#run_container">Add a website</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../podman-intro.html#enter_container">Look inside a container</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../podman-intro.html#copy_data">Copying data out</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../podman-intro.html#committing_containers">Committing Containers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../podman-intro.html#stop_container">Stopping Containers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../podman-intro.html#remove_containers">Removing Containers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../podman-intro.html#rerunning_container">Re-running Containers</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../container-persistence.html">Persistence and Containers</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../container-persistence.html#mounting_volumes">Mounting Volumes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../container-persistence.html#test_mount">Testing the Volume Mount</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../containers-and-security.html">Container Security</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../containers-and-security.html#exploit_containers">Exploit a Container</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../containers-and-security.html#run_containers_responsibly">Run Containers Responsibly</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../containers-and-security.html#scanning_containers">Scanning Containers for Security Issues</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../build-your-own-container.html">Building Securely</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../build-your-own-container.html">Build your own Secure Container</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../build-your-own-container-containerfile.html">Buildah and Containerfiles</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../deploy-container.html">Deploying to OpenShift</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../DATABASES/databases-and-containers.html">Optional</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../DATABASES/databases-and-containers.html">Containerized Databases</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="compose-container.html">Multi containers with Podman</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../PODMAN_ROOTLESS/podman-rootless.html">Rootless Containers</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Build a Container Workshop</span>
    <span class="version">1.0</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Build a Container Workshop</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">1.0</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Build a Container Workshop</a></li>
    <li><a href="../DATABASES/databases-and-containers.html">Optional</a></li>
    <li><a href="compose-container.html">Multi containers with Podman</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="file:///Users/bfarr/projects/build-a-container-workshop/documentation/modules/PODMAN_COMPOSE/pages/compose-container.adoc">Edit this Page</a></div>
</div>
  <div class="content">
<article class="doc">
<h1 class="page">Using Podman with Multiple Containers</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><em>15 MINUTE EXERCISE</em></p>
</div>
<div class="paragraph">
<p>As soon as you start using one container, you start to recognise the need for multiple containers and get to the problem of scaling and orchestrating.</p>
</div>
<div class="paragraph">
<p>Podman exists to offer a daemonless container engine for managing OCI-compliant containers on your Linux system. Users love it for its ease of adoption as an alternative to Docker. However, many users and the broader container community have been telling us that one missing feature - compatibility with Docker Compose.</p>
</div>
<div class="paragraph">
<p>In this section, we are going to demonstrate the steps you need to orchestrate multiple containers on RHEL 8. Specifically how Podman can take you a step towards packaging containers for Kubernetes with the following:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Using docker-compose with Podman</p>
</li>
<li>
<p>Using Podman to auto-generate yaml for Kubernetes and play it for containers.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>There is an open source project Podman Compose (<a href="https://github.com/containers/podman-compose" class="bare">https://github.com/containers/podman-compose</a>) but its not (at this stage) supported by Red Hat and is not covered in this lab.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_why_docker_compose"><a class="anchor" href="#_why_docker_compose"></a>Why Docker Compose?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Many people use Docker Compose for one simple reason: I can define my applications in a portable and easy-to-write YAML file, which gives me the ability to group each site with its dependencies.
For instance, this site requires a web server running PHP and a database to store its data. Those are two containers, and managing them separately seems silly.
Instead, I grouped them in a Docker Compose file. This solution allows me to work with the whole stack when I want to do things like stop services, or pull in updates for the container images I chose to use.</p>
</div>
<div class="paragraph">
<p>Examples of Docker compose files can be found here: <a href="https://github.com/docker/awesome-compose.git" class="bare">https://github.com/docker/awesome-compose.git</a>. Below is an example of docker compose yaml file which will be similar to what we use in this lab.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>version: '3.7'
services:
  gitea:
    image: gitea/gitea:latest
    environment:
      - DB_TYPE=postgres
      - DB_HOST=db:5432
      - DB_NAME=gitea
      - DB_USER=gitea
      - DB_PASSWD=gitea
    restart: always
    volumes:
      - git_data:/data
    ports:
      - 3000:3000
  db:
    image: postgres:alpine
    environment:
      - POSTGRES_USER=gitea
      - POSTGRES_PASSWORD=gitea
      - POSTGRES_DB=gitea
    restart: always
    volumes:
      - db_data:/var/lib/postgresql/data
    expose:
      - 5432
volumes:
  db_data:
  git_data:</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_podman_support_with_docker_compose"><a class="anchor" href="#_podman_support_with_docker_compose"></a>Podman support with Docker Compose</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Up to now, support for Docker Compose, the command-line utility that orchestrates multiple Docker containers for local development, was missing. With Podman 3, we have begun to support Compose.</p>
</div>
<div class="paragraph">
<p>Docker Compose is a python based application which is used to co-ordinate multiple containers. It communicates with docker behind the scenes via an API layer. With RHEL 8 and the removal of docker as a package,
this restful API backend has now been implemented to use daemonless Podman. Docker compose requires root access and the this experience of Docker-compose with root access is now available in Podman.</p>
</div>
<div class="paragraph">
<p>The api requires the podman-docker package to be installed and the podman api to be enabled which we have seen with RHEL Cockpit.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_setup_docker_compose_with_podman"><a class="anchor" href="#_setup_docker_compose_with_podman"></a>Setup Docker Compose with Podman</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The first step is to ensure that all the required packages are installed and set up the Podman (3.0 or greater) system service using systemd and api is enabled. The docker-compose executable is downloaded directly but this can also be installed with pip on some systems if a build is unavailable.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo yum install podman-docker</code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl -L "https://github.com/docker/compose/releases/download/1.29.1/docker-compose-$(uname -s)-$(uname -m)" -o docker-compose</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the binary is downloaded, we move it into /usr/local/bin and we make it executable:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo mv docker-compose /usr/local/bin &amp;&amp; sudo chmod +x /usr/local/bin/docker-compose</code></pre>
</div>
</div>
<div class="paragraph">
<p>After installing the packages, start the Podman systemd socket-activated service using the following command:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo systemctl start podman.socket</code></pre>
</div>
</div>
<div class="paragraph">
<p>Verify the system service is running by hitting the ping endpoint and see if we get a response. This step needs to be successful before we can proceed further. Confirm "OK" is returned.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo curl -H "Content-Type: application/json" --unix-socket /var/run/docker.sock <a href="http://localhost/_ping" class="bare">http://localhost/_ping</a></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can now confidently run Compose knowing the RESTful API is working.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_using_docker_compose_with_podman"><a class="anchor" href="#_using_docker_compose_with_podman"></a>Using Docker Compose with Podman</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following exercise demonstrates how to use Compose by using two examples that Docker has curated and maintained
in the awesome-compose (<a href="https://github.com/docker/awesome-compose" class="bare">https://github.com/docker/awesome-compose</a>) Git repository. If git is not installed, then use yum to install it.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo yum install git</code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">git clone <a href="https://github.com/docker/awesome-compose.git" class="bare">https://github.com/docker/awesome-compose.git</a></code></pre>
</div>
</div>
<div class="paragraph">
<p>There are many examples in this repository, but we will use a base setup for the project Gitea, which describes itself as a community-managed lightweight code hosting solution written in Golang.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cd awesome-compose/gitea-postgres</code></pre>
</div>
</div>
<div class="paragraph">
<p>The docker-compose up command looks for the docker-compose.yaml within the directory. Run the following to bring up the containers.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo env "PATH=$PATH" docker-compose up</code></pre>
</div>
</div>
<div class="paragraph">
<p>The README for this docker-compose setup says to visit localhost:3000 in your browser to verify it is working.
By the Compose output, you should see that docker-compose has created a network, two volumes, and two containers. We can observe the two containers in another terminal with the podman ps command.
In a new terminal run the following podman command</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo podman ps</code></pre>
</div>
</div>
<div class="paragraph">
<p>The network can be seen with podman network ls.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo podman network ls</code></pre>
</div>
</div>
<div class="paragraph">
<p>Lastly, the volumes can be displayed with podman volume ls.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo podman volume ls</code></pre>
</div>
</div>
<div class="paragraph">
<p>To bring down the Docker Compose containers, we just need to interrupt docker-compose with a Ctrl+C.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>^CGracefully stopping... (press Ctrl+C again to force)
Stopping gitea-postgres_gitea_1 ... done
Stopping gitea-postgres_db_1    ... done
$</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_using_podman_to_bridge_to_kubernetes"><a class="anchor" href="#_using_podman_to_bridge_to_kubernetes"></a>Using Podman to bridge to Kubernetes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this exercise we will look out how Podman can provide a bridge to Kubernetes by generating or using kubernetes based yaml files rather than Docker compose yaml files.
With Docker and Podman we have been running containers so far, but with this step we will use "pods" which are the  lowest schedulable unit in kubernetes. Pods can container
one or more containers.</p>
</div>
<div class="paragraph">
<p>Podman pods are similiar to kubernetes pods in the sense that they can contain one or more containers at a time. With podman play command, you can import kubernetes pod definitions in yaml format.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/podman-pod-architecture.png" alt="Gitea!">
</div>
</div>
<div class="paragraph">
<p>Every Podman pod includes an "infra" container. Its purpose is to hold the namespaces associated but it does nothing, but go to sleep. Its purpose is to hold the namespaces associated with the pod and allow podman
to connect other containers to the pod.  This allows you to start and stop containers within the POD and the pod will stay running, where as if the primary container
controlled the pod, this would not be possible.</p>
</div>
<div class="paragraph">
<p>With our previous docker compose file run docker-compose and find the container names which are running.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo env "PATH=$PATH" docker-compose up</code></pre>
</div>
</div>
<div class="paragraph">
<p>In a new terminal run the following podman command</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo podman ps</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>[student2@ansible-1 ~]$ sudo podman ps
CONTAINER ID  IMAGE                              COMMAND               CREATED         STATUS             PORTS                   NAMES
7997ea39059d  docker.io/library/postgres:alpine  postgres              7 hours ago     Up 28 seconds ago                          gitea-postgres_db_1
6a5500ebf45e  docker.io/gitea/gitea:latest       /bin/s6-svscan /e...  28 seconds ago  Up 28 seconds ago  0.0.0.0:3000-&gt;3000/tcp  gitea-postgres_gitea_1</pre>
</div>
</div>
<div class="paragraph">
<p>Now we have two containers running. Lets export the kuubernetes yaml associated, replace gitea-postgres_db_1 and gitea-postgres_gitea_1 with names</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo podman generate kube gitea-postgres_db_1 &gt; gitea-postgres_db.yml</code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo podman generate kube gitea-postgres_gitea_1 &gt; gitea-postgres_gitea.yml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Take a look at the files generated to familiarise what has been generated</p>
</div>
<div class="listingblock">
<div class="content">
<pre># Generation of Kubernetes YAML is still under development!
#
# Save the output of this file and use kubectl create -f to import
# it into Kubernetes.
#
# Created with podman-3.0.2-dev
apiVersion: v1
kind: Pod
metadata:
  creationTimestamp: "2021-06-17T01:01:28Z"
  labels:
    app: gitea-postgresdb1
  name: gitea-postgresdb1
spec:
  containers:
  - args:
    - postgres
    command:
    - docker-entrypoint.sh
    env:
    - name: PATH
      value: /usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
    - name: TERM
      value: xterm
    - name: container
      value: podman
    - name: LANG
      value: en_US.utf8
    - name: PG_MAJOR
      value: "13"
    - name: PGDATA
      value: /var/lib/postgresql/data
    - name: POSTGRES_PASSWORD
      value: gitea
    - name: PG_VERSION
      value: "13.3"
    - name: PG_SHA256
      value: 3cd9454fa8c7a6255b6743b767700925ead1b9ab0d7a0f9dcb1151010f8eb4a1
    - name: POSTGRES_USER
      value: gitea
    - name: POSTGRES_DB
      value: gitea
    image: docker.io/library/postgres:alpine
    name: gitea-postgresdb1
    resources: {}
    securityContext:
      allowPrivilegeEscalation: true
      capabilities:
        drop:
        - CAP_MKNOD
        - CAP_AUDIT_WRITE
      privileged: false
      readOnlyRootFilesystem: false
      seLinuxOptions: {}
    workingDir: /
  dnsConfig: {}
status: {}</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre># Generation of Kubernetes YAML is still under development!
#
# Save the output of this file and use kubectl create -f to import
# it into Kubernetes.
#
# Created with podman-3.0.2-dev
apiVersion: v1
kind: Pod
metadata:
  creationTimestamp: "2021-06-17T01:01:34Z"
  labels:
    app: gitea-postgresgitea1
  name: gitea-postgresgitea1
spec:
  containers:
  - args:
    - /bin/s6-svscan
    - /etc/s6
    command:
    - /usr/bin/entrypoint
    env:
    - name: PATH
      value: /usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
    - name: TERM
      value: xterm
    - name: container
      value: podman
    - name: GITEA_CUSTOM
      value: /data/gitea
    - name: DB_NAME
      value: gitea
    - name: DB_USER
      value: gitea
    - name: DB_PASSWD
      value: gitea
    - name: USER
      value: git
    - name: DB_TYPE
      value: postgres
    - name: DB_HOST
      value: db:5432
    image: docker.io/gitea/gitea:latest
    name: gitea-postgresgitea1
    ports:
    - containerPort: 3000
      hostPort: 3000
      protocol: TCP
    resources: {}
    securityContext:
      allowPrivilegeEscalation: true
      capabilities:
        drop:
        - CAP_MKNOD
        - CAP_AUDIT_WRITE
      privileged: false
      readOnlyRootFilesystem: false
      seLinuxOptions: {}
    workingDir: /
  dnsConfig: {}
status: {}</pre>
</div>
</div>
<div class="paragraph">
<p>Now stop the gitea process by stopping the docker compose or using podman stop on both containers.
To bring down the Docker Compose containers, we just need to interrupt docker-compose with a Ctrl+C.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>^CGracefully stopping... (press Ctrl+C again to force)
Stopping gitea-postgres_gitea_1 ... done
Stopping gitea-postgres_db_1    ... done
$</pre>
</div>
</div>
<div class="paragraph">
<p>So lets now run the gitea process as a pod with 2 containers rather than the docker compose file. The following file has been created on from the generated yaml file by podman on both containers.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cat &lt;&lt;EOF &gt; gitea_pod.yml
# Generation of Kubernetes YAML is still under development!
#
# Save the output of this file and use kubectl create -f to import
# it into Kubernetes.
#
# Created with podman-3.0.2-dev
apiVersion: v1
kind: Pod
metadata:
  creationTimestamp: "2021-06-17T01:01:28Z"
  labels:
    app: gitea-postgresdb1
  name: gitea-postgresdb1
spec:
  containers:
  - args:
    - /bin/s6-svscan
    - /etc/s6
    command:
    - /usr/bin/entrypoint
    env:
    - name: PATH
      value: /usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
    - name: TERM
      value: xterm
    - name: container
      value: podman
    - name: GITEA_CUSTOM
      value: /data/gitea
    - name: DB_NAME
      value: gitea
    - name: DB_USER
      value: gitea
    - name: DB_PASSWD
      value: gitea
    - name: USER
      value: git
    - name: DB_TYPE
      value: postgres
    - name: DB_HOST
      value: localhost:5432
    image: docker.io/gitea/gitea:latest
    name: gitea-postgresgitea1
    ports:
    - containerPort: 3000
      hostPort: 3000
      protocol: TCP
    resources: {}
    securityContext:
      allowPrivilegeEscalation: true
      capabilities:
        drop:
        - CAP_MKNOD
        - CAP_AUDIT_WRITE
      privileged: false
      readOnlyRootFilesystem: false
      seLinuxOptions: {}
    workingDir: /
  - args:
    - postgres
    command:
    - docker-entrypoint.sh
    env:
    - name: PATH
      value: /usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
    - name: TERM
      value: xterm
    - name: container
      value: podman
    - name: LANG
      value: en_US.utf8
    - name: PG_MAJOR
      value: "13"
    - name: PGDATA
      value: /var/lib/postgresql/data
    - name: POSTGRES_PASSWORD
      value: gitea
    - name: PG_VERSION
      value: "13.3"
    - name: PG_SHA256
      value: 3cd9454fa8c7a6255b6743b767700925ead1b9ab0d7a0f9dcb1151010f8eb4a1
    - name: POSTGRES_USER
      value: gitea
    - name: POSTGRES_DB
      value: gitea
    image: docker.io/library/postgres:alpine
    name: gitea-postgresdb1
    ports:
    - containerPort: 5432
      hostPort: 5432
      protocol: TCP
    resources: {}
    securityContext:
      allowPrivilegeEscalation: true
      capabilities:
        drop:
        - CAP_MKNOD
        - CAP_AUDIT_WRITE
      privileged: false
      readOnlyRootFilesystem: false
      seLinuxOptions: {}
    workingDir: /
  dnsConfig: {}
status: {}
EOF</code></pre>
</div>
</div>
<div class="paragraph">
<p>Copy the above and save it to gitea_pod.yml</p>
</div>
<div class="paragraph">
<p>podman play kube will read in a structured file of Kubernetes YAML. It will then recreate the containers, pods or volumes described in the YAML.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo podman play kube gitea_pod.yml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Navigate to localhost:3000 in your local browser and check the gitea is now running now in a pod rather than through Docker compose.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/gitea.png" alt="Gitea!">
</div>
</div>
<div class="paragraph">
<p>We can list the pods using podman pod ls or podman pod list command:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo podman pod list</code></pre>
</div>
</div>
<div class="paragraph">
<p>Congratulations you have now completed this task and understood how Podman can support multiple containers.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_further_examples_using_pods_with_podman"><a class="anchor" href="#_further_examples_using_pods_with_podman"></a>Further examples using pods with Podman</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Take a look at the help and the options you get with podman pod command.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>sudo podman pod --help</pre>
</div>
</div>
<div class="paragraph">
<p>If you need to rsh into a pod you can always use this command</p>
</div>
<div class="listingblock">
<div class="content">
<pre>sudo podman exec -it &lt;pod_id/name&gt; /bin/bash</pre>
</div>
</div>
<div class="paragraph">
<p>The following commands are useful to understand and try with your new pod running.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>sudo podman pod stop &lt;pod_name&gt;
sudo podman pod rm &lt;pod_name&gt;
sudo podman pod create -n my-app -p &lt;port&gt;:&lt;port&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>Example wordpress site - Create a pod manually and add 2 containers</p>
</div>
<div class="listingblock">
<div class="content">
<pre>#create pod and add maridb container in one go
sudo podman run \
-d --restart=always --pod new:wpapp_pod \
-e MYSQL_ROOT_PASSWORD="myrootpass" \
-e MYSQL_DATABASE="wp-db" \
-e MYSQL_USER="wp-user" \
 -e MYSQL_PASSWORD="w0rdpr3ss" \
 -p 9080:80 \
 --name=wptest-db mariadb

# add wordpress container to pod wpapp_pod
sudo podman run \
 -d --restart=always --pod=wpapp_pod \
 -e WORDPRESS_DB_NAME="wp-db" \
 -e WORDPRESS_DB_USER="wp-user" \
 -e WORDPRESS_DB_PASSWORD="w0rdpr3ss" \
 -e WORDPRESS_DB_HOST="127.0.0.1" \
 --name wptest-web wordpress</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_running_in_openshift"><a class="anchor" href="#_running_in_openshift"></a>Running in OpenShift</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The generated yaml here is still in an early phase but it can provide you the basis to develop your yaml when migrating from Docker to Kubernetes. Note we have generated yaml for
a Pod and typically you may want to build yaml for Deployment/ConfigMap/Secret etc.
You can stil try to apply this yaml and get a running Pod in OpenShift, but may need some tweaks which we found like removing the "seLinuxOptions" line.</p>
</div>
<div class="paragraph">
<p>In the next section you will use OpenShift. Outside of this lab you are welcome to sign up for a free Developer sandbox environment.
<a href="https://developers.redhat.com/developer-sandbox/activities/get-started-with-your-developer-sandbox" class="bare">https://developers.redhat.com/developer-sandbox/activities/get-started-with-your-developer-sandbox</a></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you are trying to deploy in the sandbox from docker.io container registry , there can be errors if docker pull limits are reached due to the popularity of the sandboxes. In this case you can adjust the image in the yaml to the following
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_wrap_up"><a class="anchor" href="#_wrap_up"></a>Wrap up</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Red Hat engineers have taken a step towards suupport of Docker compose with Podman. It has been a Minumum Viable Product (MVP) approach which brings the same experience (running as root). This is an area that will continue to develop given some of the Podman fundamentals such as not running as priveleged is not yet 100%. However it should enable the ability for organisations to move their Docker compose setups to Podman and embrace Kubernetes standards.</p>
</div>
<div class="paragraph">
<p>One known caveat is that Podman has not and will not implement the Swarm function. Therefore, if your Docker Compose instance uses Swarm, it will not work with Podman.
With the 3.0 release, Podman can now work nicely with Docker Compose to orchestrate containers, which is a huge step toward daemonless container management on Linux.</p>
</div>
<div class="paragraph">
<p>The following links to various articles provide further reading and reference to the Move to Kube project which helps to move docker compose files as well.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Podman Managing pods and containers in a local container runtime: <a href="https://www.redhat.com/sysadmin/podman-play-kube" class="bare">https://www.redhat.com/sysadmin/podman-play-kube</a></p>
</li>
<li>
<p>Articles by a Principal Engineer leading the Container Runtimes team: <a href="https://www.redhat.com/sysadmin/users/brent-baude" class="bare">https://www.redhat.com/sysadmin/users/brent-baude</a></p>
</li>
<li>
<p>Move to Kube &amp; Docker Compose: <a href="https://move2kube.konveyor.io/tutorials/docker-compose/" class="bare">https://move2kube.konveyor.io/tutorials/docker-compose/</a></p>
</li>
<li>
<p>For an in depth discussion, this video provides a good discussion to understand the hows and whys of supporting docker-compose with Podman. The Level Up Hour (E29): Docker Compose with Podman v3  - <a href="https://www.youtube.com/watch?v=hyOXwzvLXOM" class="bare">https://www.youtube.com/watch?v=hyOXwzvLXOM</a></p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you try something that works with Docker and doesn&#8217;t work with non-root Podman, first try root with Podman.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="../DATABASES/databases-and-containers.html" class="query-params-link">Optional</a></span>
  <span class="next"><a href="../PODMAN_ROOTLESS/podman-rootless.html" class="query-params-link">Rootless Containers</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../../../_/js/vendor/clipboard.js"></script>
<script src="../../../_/js/site.js"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>  </body>
</html>
