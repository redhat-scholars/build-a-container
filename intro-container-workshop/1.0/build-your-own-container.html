<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Build your own Secure Container :: BUILD-A-CONTAINER WORKSHOP</title>
    <link rel="canonical" href="https://bfarr-rh.github.io/build-a-container/intro-container-workshop/1.0/build-your-own-container.html">
    <link rel="prev" href="containers-and-security.html">
    <link rel="next" href="build-your-own-container-containerfile.html">
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../../_/css/site.css">
<link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script type="text/javascript">

   $( document ).ready(function() {
    $('li.version a, a.version').click(function() {
            var querystring = window.location.search;
            var href = $(this).attr('href');
            location.href = href + querystring;
            return false;
      });
  });
    
  </script>
  <style>
    /* override master stylesheet properties for this partial here */

    .navbar-item {
      flex: unset;
    }

    .doc {
      max-width: unset;
    }

    .bac-red {
        color: red;
    }
    .bac-h1 {
        font-size: 1.8em;
        margin: auto;
        display:table;
        color: red;
    }

  </style>

  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img
          src="../../_/img/header_logo.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://bfarr-rh.github.io/build-a-container">BUILD-A-CONTAINER WORKSHOP</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
        <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-scholars.github.io/outer-loop-guides/" target="_blank">Outer Loop</a>
            <a class="navbar-item" href="https://redhat-scholars.github.io/openshift-starter-guides/" target="_blank">OpenShift Starter</a>
            <a class="navbar-item" href="https://redhat-scholars.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-scholars.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-scholars.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header><div class="body">
<div class="nav-container" data-component="intro-container-workshop" data-version="1.0">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html" class=" query-params-link">BUILD-A-CONTAINER</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="introduction.html">Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="introduction.html#open_code_server">Code Server</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="introduction.html#open_code_server_terminal">Open Terminal</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="introduction.html#open_code_server_terminal_commands">Issuing Terminal Commands</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="introduction.html#local_browser">Local Browser</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="container-anatomy.html">Container Anatomy</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="container-anatomy.html#what_makes_up_a_container">What makes up a Container?</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="container-anatomy.html#container_image_format">Container Image Format</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="container-anatomy.html#container_file">Containerfile</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="container-anatomy.html#container_identification">Container Identification</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="container-anatomy.html#container_runtime">Container Runtime</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="container-anatomy.html#container_tools">Container Tools</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="container-anatomy.html#container_registries">Container Registries</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="container-anatomy.html#more_information">More information</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="podman-intro.html">Running Containers</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="podman-intro.html#run_container">Add a website</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="podman-intro.html#enter_container">Look inside a container</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="podman-intro.html#copy_data">Copying data out</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="podman-intro.html#committing_containers">Committing Containers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="podman-intro.html#stop_container">Stopping Containers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="podman-intro.html#remove_containers">Removing Containers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="podman-intro.html#rerunning_container">Re-running Containers</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="container-persistence.html">Persistence and Containers</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="container-persistence.html#mounting_volumes">Mounting Volumes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="container-persistence.html#test_mount">Testing the Volume Mount</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="containers-and-security.html">Container Security</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="containers-and-security.html#exploit_containers">Exploit a Container</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="containers-and-security.html#run_containers_responsibly">Run Containers Responsibly</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="containers-and-security.html#scanning_containers">Scanning Containers for Security Issues</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="build-your-own-container.html">Building Securely</a>
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="build-your-own-container.html">Build your own Secure Container</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="build-your-own-container-containerfile.html">Buildah and Containerfiles</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="deploy-container.html">Deploying to OpenShift</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="DATABASES/databases-and-containers.html">Optional</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="DATABASES/databases-and-containers.html">Containerized Databases</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="PODMAN_COMPOSE/compose-container.html">Docker Compose &amp; Pods</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="PODMAN_ROOTLESS/podman-rootless.html">Rootless Containers</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">BUILD-A-CONTAINER</span>
    <span class="version">1.0</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">BUILD-A-CONTAINER</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">1.0</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">BUILD-A-CONTAINER</a></li>
    <li><a href="build-your-own-container.html">Building Securely</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="file:///Users/bfarr/projects/build-a-container-workshop/documentation/modules/ROOT/pages/build-your-own-container.adoc">Edit this Page</a></div>
</div>
  <div class="content">
<article class="doc">
<h1 class="page">Build your own Secure Container</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><em>10 MINUTE EXERCISE</em></p>
</div>
<div class="paragraph">
<p>In this chapter we&#8217;ll try to make the container image we&#8217;ve been using a bit more secure using a related tool to <code>podman</code>, namely <code>buildah</code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/buildah.png" alt="Buildah!" width="320" height="78">
</div>
</div>
<div class="paragraph">
<p><code>buildah</code> is used to create OCI-compliant container images, such as the <code>quay.io/bfarr/container-workshop-httpd</code> that we&#8217;ve been using.  We&#8217;ll start by fixing a the security vulnerability we found in the <a href="containers-and-security.html?FOO=bar" target="_blank" rel="noopener">previous section</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="buildah_native"><a class="anchor" href="#buildah_native"></a>Buildah native commands</h2>
<div class="sectionbody">
<div class="paragraph">
<p>One of the things that makes <code>buildah</code> unique is the ability to interact with container images from the host&#8217;s command line.  (As we&#8217;ll see in the next section, it also allows the creation of images from a <code>Dockerfile</code> or, more generically a " <code>Containerfile</code> ").  This will make it easy for us to remediate the vulnerability we found in the last section.</p>
</div>
<div class="paragraph">
<p>Where we left off with our container image is that we needed to patch the bash package installed on the container</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/security-bulletin.png" alt="security bulletin">
</div>
<div class="title">Figure 1. Need to upgrade bash</div>
</div>
<div class="paragraph">
<p>This can be problematic if our image does not already have installed on it all the tools (such as package management tools like <code>dnf</code> or <code>yum</code>) necessary to remediate the problem.  But with buildah&#8217;s <strong>native command functionality</strong> this is no longer a problem.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If you don&#8217;t have one open already, open a terminal as a non-root user and confirm your user by running the following command:</p>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">whoami</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">%USER%</code></pre>
</div>
</div>
</li>
<li>
<p>Next, as a non-root user we need to do some setup that will allow buildah to interact with the container in this native command mode.  Run the following in the terminal</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The main reason for running this command is that we&#8217;ll be mounting filesystems inside the container and non-root users normally do not have privileges to do this.  Running <code>buildah unshare</code> is a way of preparing to work with containers "rootlessly" (if you will).  For a discussion of what this is, see <a href="https://www.redhat.com/sysadmin/buildah-unshare-command" target="_blank" rel="noopener">here</a>.</p>
</div>
<div class="paragraph">
<p>Think of it as a way that <code>buildah</code> can work with container "rootlessly" just as <code>podman</code> did in the <a href="containers-and-security.html?USER=%USER%&amp;CLUSTER_SUBDOMAIN=%CLUSTER_SUBDOMAIN%#non_root_containers" target="_blank" rel="noopener">last section</a></p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">buildah unshare</code></pre>
</div>
</div>
</li>
<li>
<p>You should notice that upon running the command your terminal turns to look like a root terminal.  You are not actually root, but rather working within a "namespace" that makes you appear as root when it comes to interacting with buildah&#8217;s containers</p>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">[root@ansible-1 ~]#</code></pre>
</div>
</div>
</li>
<li>
<p>Next we tell buildah to implicitly create a "working container" from our currently vulnerable image:</p>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">CONTAINER=$(buildah from quay.io/bfarr/container-workshop-httpd) <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We&#8217;re effectively assigning a the shell variable <code>CONTAINER</code> to the id of the buildah container that starts with the state of the image we want to update</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you haven&#8217;t yet downloaded the image, the image might be downloaded first from the image registry before you can enter the next command</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>To confirm that our working container is up, we can run the following command (which is a little like <code>podman ps</code> but for "working containers")</p>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">buildah containers</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">CONTAINER ID  BUILDER  IMAGE ID     IMAGE NAME                       CONTAINER NAME
ef575a8a3408     *     60dde8abf76e quay.io/bfarr/container-wo... container-workshop-httpd-working-container</code></pre>
</div>
</div>
</li>
<li>
<p>We can then use buildah to effectively mount the root of the container&#8217;s filesystem</p>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">CONTAINER_MOUNT_POINT=$(buildah mount ${CONTAINER}) \<i class="conum" data-value="1"></i><b>(1)</b>
&& echo "Container ${CONTAINER}'s filesystem mounted on host at ${CONTAINER_MOUNT_POINT}"</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>CONTAINER_MOUNT_POINT is getting set with the path to the mount in the host filesystem.  We store it in a shell variable because this tends to be a long path</td>
</tr>
</table>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code>Container container-workshop-httpd-working-container's filesystem mounted on host at /home/%USER%/.local/share/containers/storage/overlay/<mark>500abaa5921678c20f37f689ae72e37734445934e8c223775a2b71cce091e3f6</mark>/merged <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The highlighted section will be different on your instance.  This is just making clear where the container mount point is</td>
</tr>
</table>
</div>
</li>
<li>
<p>We can even peek inside the container image through the mount point</p>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ls -l ${CONTAINER_MOUNT_POINT}</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">total 0
lrwxrwxrwx.  1 root root  7 Apr 20 03:58 bin -&gt; usr/bin
dr-xr-xr-x.  2 root root  6 Dec 14  2017 boot
drwxr-xr-x.  2 root root  6 Apr 20 03:58 dev
drwxr-xr-x. 51 root root 19 May 30 08:29 etc
drwxr-xr-x.  2 root root  6 Apr 20 04:00 home
lrwxrwxrwx.  1 root root  7 Apr 20 03:58 lib -&gt; usr/lib
lrwxrwxrwx.  1 root root  9 Apr 20 03:58 lib64 -&gt; usr/lib64
drwxr-xr-x.  2 root root  6 Dec 14  2017 media
drwxr-xr-x.  2 root root  6 Dec 14  2017 mnt
drwxr-xr-x.  2 root root  6 Dec 14  2017 opt
drwxr-xr-x.  2 root root  6 Apr 20 03:58 proc
dr-xr-x---.  4 root root 18 May 30 08:28 root
drwxr-xr-x. 14 root root 18 May 30 08:29 run
lrwxrwxrwx.  1 root root  8 Apr 20 03:58 sbin -&gt; usr/sbin
drwxr-xr-x.  2 root root  6 Dec 14  2017 srv
drwxr-xr-x.  2 root root  6 Apr 20 03:58 sys
drwxrwxrwt.  7 root root 46 May 30 08:29 tmp
drwxr-xr-x. 13 root root 19 Apr 20 03:58 usr
drwxr-xr-x. 19 root root 17 May 30 08:29 var</code></pre>
</div>
</div>
</li>
<li>
<p>Now that we have a mount point we can copy files from the host directly into the container.  In our case however, we want to use the <strong>host&#8217;s</strong> package management tooling to install the updated bash package on the container <code>${CONTAINER}</code>. <span id="upgrade_bash">Run</span> this command:</p>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">dnf install -y \<i class="conum" data-value="1"></i><b>(1)</b>
    --installroot=$CONTAINER_MOUNT_POINT \<i class="conum" data-value="2"></i><b>(2)</b>
    bash <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>dnf is the package management tool installed on your host instance.  The <code>-y</code> means that if dnf prompts the user, such as whether to install a given package, the answer will always be yes</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This tells dnf that the requested packages should be installed relative to this installroot (<code>${CONTAINER_MOUNT_POINT}</code> and thus the root of the container) instead of '/', the root of the host instance</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We are telling dnf to install the latest available compatible version of bash for our container (i.e. at <code>--installroot</code>)</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You may see a few errors upon running the above command.  They are non-critical.  The important thing is that you see the highlighted section below in your own local output</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>In the output the key message you should see is highlighted:</p>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">Package bash-4.2.45-2.el7.x86_64 is already installed.
Dependencies resolved.
===================================================================================================
 Package             Architecture          Version                      Repository            Size
===================================================================================================
Upgrading:
 bash                x86_64                4.2.46-34.el7                ubi-7                1.0 M

Transaction Summary
===================================================================================================
Upgrade  1 Package

Total download size: 1.0 M
Downloading Packages:
bash-4.2.46-34.el7.x86_64.rpm                                      415 kB/s | 1.0 MB     00:02
---------------------------------------------------------------------------------------------------
Total                                                              414 kB/s | 1.0 MB     00:02
Running transaction check
Transaction check succeeded.
Running transaction test
Transaction test succeeded.
Running transaction
  Preparing        :                                                                           1/1
  Upgrading        : bash-4.2.46-34.el7.x86_64                                                 1/2
  Running scriptlet: bash-4.2.46-34.el7.x86_64                                                 1/2
  Cleanup          : bash-4.2.45-2.el7.x86_64                                                  2/2
  Running scriptlet: bash-4.2.45-2.el7.x86_64                                                  2/2
  Verifying        : bash-4.2.46-34.el7.x86_64                                                 1/2
  Verifying        : bash-4.2.45-2.el7.x86_64                                                  2/2
Installed products updated.

<mark>Upgraded:</mark>
  <mark>bash-4.2.46-34.el7.x86_64</mark>  <i class="conum" data-value="1"></i><b>(1)</b>

<mark>Complete!</mark></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Notice that this package is more recent than the minimum release needed to address the vulnerability</td>
</tr>
</table>
</div>
</li>
<li>
<p>Now we will commit these changes to a new image locally on the host that we&#8217;ll test.  We commit the changes with</p>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">buildah commit \<i class="conum" data-value="1"></i><b>(1)</b>
    ${CONTAINER} \<i class="conum" data-value="2"></i><b>(2)</b>
    localhost/container-workshop-httpd-secure <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>commit</code> means to take the working container and save it as a container image</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This is the ID of the working container that we want saved as an image</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The name the image should be saved as.  This saves the image to the user&#8217;s local container store on the host instance</td>
</tr>
</table>
</div>
</li>
<li>
<p>This should yield output like the following</p>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">Getting image source signatures
Copying blob 123257361dae skipped: already exists
Copying blob c9e02f9d3afe skipped: already exists
Copying blob 86284899b0cc skipped: already exists
Copying blob bcf3865bf7f7 skipped: already exists
Copying blob 4e7c990a129f skipped: already exists
Copying blob 210af8709b71 skipped: already exists
Copying blob 47e96512450e skipped: already exists
Copying blob 8f10e6ebff19 skipped: already exists
Copying blob 486383b07939 skipped: already exists
Copying blob 23be1053bf93 skipped: already exists
Copying blob ee738432d587 skipped: already exists
Copying blob bc71779d57e9 done
Copying config 6b4a460f1e done
Writing manifest to image destination
Storing signatures
6b4a460f1e4077bd64b862fcdabe93928779e441ed3e84bb161e8cead079a3e0</code></pre>
</div>
</div>
</li>
<li>
<p>Now we can <code>exit</code> the unshare environment so that we can properly test out our container fix</p>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">exit</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="_testing_commited_container"><a class="anchor" href="#_testing_commited_container"></a>Testing commited container</h3>
<div class="paragraph">
<p>Now that we committed a new image, we can test this committed image</p>
</div>
<div class="paragraph">
<p>Make sure there are no containers running with the <code>my-web-server</code></p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">podman rm -f my-web-server</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If there were a container running you would see something like:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">17af59003b1f956717b2a90919119b20bca1133e3677999f628f00e026a0079f</code></pre>
</div>
</div>
<div class="paragraph">
<p>And if there weren&#8217;t one running you would see something like:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">Error: failed to evict container: "": failed to find container "my-web-server" in state: no container with name or ID my-web-server found: no such container</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the output you see is either of the above, it&#8217;s okay to proceed.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Run the new container "rootlessly" in the terminal by running the following command:</p>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">podman run \
    -d \
    -p 8081:80/tcp \<i class="conum" data-value="1"></i><b>(1)</b>
    --name my-web-server \
    -v /home/%USER%/container-workshop:/var/log/www:Z \
    localhost/container-workshop-httpd-secure</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Since our new container image is virtually identical to the original one (except for the new bash package) and we&#8217;re forwarding the same ports we can now attempt to exploit the container again with the configuration from before</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Let&#8217;s return to our metasploit terminal (<strong>Terminal 2</strong>) for the next section</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you have accidentally closed your metasploit terminal, you can recreate/reopen it by following <a href="metasploit_setup_standalone.html?USER=%USER%&amp;CLUSTER_SUBDOMAIN=%CLUSTER_SUBDOMAIN%" target="_blank" rel="noopener">these instructions</a> fully in the other tab and then returning to this point in the lab.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you&#8217;ve left your terminal open, you may need to first press <kbd>RETURN</kbd> to get back to the metasploit command line.  When you do so you may be greeted with the following prompt:</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset1_terminal-2"></a>Terminal 2</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset1_terminal-2">
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">Terminate channel 1? [<mark>y</mark>/N]</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Just enter <code>y</code> to get back to the metasploit prompt:</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset2_terminal-2"></a>Terminal 2</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset2_terminal-2">
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">msf6 exploit(multi/http/apache_mod_cgi_bash_env_exec) &gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Next run the following command in the <strong>metasploit</strong> terminal (<strong>Terminal 2</strong>)</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset3_terminal-2"></a>Terminal 2</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset3_terminal-2">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">check</code></pre>
</div>
</div>
<div class="paragraph">
<p>And this should result in the following output:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">[*] 127.0.0.1:8081 - The target is <mark>not</mark> exploitable.</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Congratulations!  You&#8217;d fixed the shellshock exploit of the original <code>quay.io/bfarr/container-workshop-httpd</code> container!</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">TIP</div>
<div class="paragraph">
<p>You are now done with metasploit and Terminal 2.  You can close down that terminal with the following commands:</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset4_terminal-2"></a>Terminal 2</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset4_terminal-2">
<div class="paragraph">
<p>First exit out of metasploit</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">exit</code></pre>
</div>
</div>
<div class="paragraph">
<p>Which should return you to the lab instance terminal</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">[%USER%@ansible-1 ~]$</code></pre>
</div>
</div>
<div class="paragraph">
<p>And now exit out of that terminal</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">exit</code></pre>
</div>
</div>
<div class="paragraph">
<p>Which should return you terminal to a single "unsplit" terminal window</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/terminal-unsplit.png" alt="terminal unsplit">
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Next let&#8217;s look at how we can make our container even more resilient against attack by using another popular way of building containers.</p>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="containers-and-security.html" class="query-params-link">Container Security</a></span>
  <span class="next"><a href="build-your-own-container-containerfile.html" class="query-params-link">Buildah and Containerfiles</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../../_/js/vendor/clipboard.js"></script>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>  </body>
</html>
